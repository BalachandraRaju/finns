<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Alerts - Pattern Analysis System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .alert-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        .alert-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .alert-buy {
            border-left-color: #28a745;
        }
        .alert-sell {
            border-left-color: #dc3545;
        }
        .super-alert {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fff9c4 0%, #ffffff 100%);
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .pattern-badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        .trigger-reason {
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.4;
        }
        .price-highlight {
            font-weight: bold;
            font-size: 1.1em;
        }
        .buy-price {
            color: #28a745;
        }
        .sell-price {
            color: #dc3545;
        }
        .super-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .sidebar {
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }
        .main-content {
            padding: 20px;
        }
        .alert-timestamp {
            font-size: 0.85em;
            color: #6c757d;
        }
        .no-alerts {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar with Filters -->
            <div class="col-md-3 sidebar">
                <h4><i class="fas fa-filter"></i> Alert Filters</h4>
                
                <!-- Statistics Cards -->
                <div class="stats-card">
                    <h6><i class="fas fa-chart-line"></i> Alert Statistics</h6>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="h4" id="total-alerts">0</div>
                            <small>Total Alerts</small>
                        </div>
                        <div class="col-6">
                            <div class="h4" id="super-alerts">0</div>
                            <small>Super Alerts</small>
                        </div>
                    </div>
                    <div class="row text-center mt-2">
                        <div class="col-6">
                            <div class="h5 text-success" id="buy-alerts">0</div>
                            <small>Buy Signals</small>
                        </div>
                        <div class="col-6">
                            <div class="h5 text-danger" id="sell-alerts">0</div>
                            <small>Sell Signals</small>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small>Accuracy Rate: <span id="accuracy-rate" class="fw-bold">0%</span></small>
                    </div>
                </div>

                <!-- Filter Form -->
                <div class="filter-section">
                    <form id="filter-form">
                        <div class="mb-3">
                            <label class="form-label">Symbol</label>
                            <input type="text" class="form-control" id="symbol-filter" placeholder="e.g., RELIANCE">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Alert Type</label>
                            <select class="form-select" id="alert-type-filter">
                                <option value="ALL">All Types</option>
                                <option value="BUY">Buy Signals</option>
                                <option value="SELL">Sell Signals</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Pattern Type</label>
                            <select class="form-select" id="pattern-filter">
                                <option value="">All Patterns</option>
                                <option value="double_top">Double Top Buy</option>
                                <option value="triple_top">Triple Top Buy</option>
                                <option value="catapult">Catapult</option>
                                <option value="pole_follow_through">Pole Follow Through</option>
                                <option value="turtle_breakout">Turtle Breakout</option>
                                <option value="abc_bullish">ABC Bullish</option>
                                <option value="abc_bearish">ABC Bearish</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="super-alerts-only">
                                <label class="form-check-label" for="super-alerts-only">
                                    <i class="fas fa-star text-warning"></i> Super Alerts Only
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Date Range</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="date" class="form-control" id="start-date">
                                </div>
                                <div class="col-6">
                                    <input type="date" class="form-control" id="end-date">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Outcome</label>
                            <select class="form-select" id="outcome-filter">
                                <option value="all">All Outcomes</option>
                                <option value="pending">Pending Analysis</option>
                                <option value="profit">Profitable</option>
                                <option value="loss">Loss</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        
                        <button type="button" class="btn btn-outline-secondary w-100 mt-2" id="clear-filters">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </form>
                </div>

                <!-- Telegram Test Button -->
                <div class="mt-3">
                    <button type="button" class="btn btn-success w-100" id="test-telegram-btn">
                        <i class="fab fa-telegram"></i> Test Telegram Alert
                    </button>
                    <div id="telegram-test-result" class="mt-2" style="display: none;"></div>
                </div>

                <!-- Quick Actions -->
                <div class="mt-3">
                    <h6><i class="fas fa-bolt"></i> Quick Actions</h6>
                    <button class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="showSuperAlertsOnly()">
                        <i class="fas fa-star"></i> Show Super Alerts
                    </button>
                    <button class="btn btn-outline-success btn-sm w-100 mb-2" onclick="showTodayAlerts()">
                        <i class="fas fa-calendar-day"></i> Today's Alerts
                    </button>
                    <button class="btn btn-outline-info btn-sm w-100 mb-2" onclick="showRecentAlerts()">
                        <i class="fas fa-clock"></i> Last 7 Days
                    </button>
                    <button class="btn btn-outline-primary btn-sm w-100" onclick="refreshAlerts()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-9 main-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-bell"></i> Trading Alerts</h2>
                    <div>
                        <button class="btn btn-outline-primary" onclick="exportAlerts()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-outline-info" onclick="showAnalytics()">
                            <i class="fas fa-chart-bar"></i> Analytics
                        </button>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading alerts...</p>
                </div>

                <!-- Alerts Container -->
                <div id="alerts-container">
                    <!-- Alerts will be loaded here -->
                </div>

                <!-- No Alerts Message -->
                <div id="no-alerts" class="no-alerts" style="display: none;">
                    <i class="fas fa-bell-slash fa-3x mb-3"></i>
                    <h5>No Alerts Found</h5>
                    <p>Try adjusting your filters or check back later for new alerts.</p>
                </div>

                <!-- Pagination -->
                <nav aria-label="Alerts pagination" id="pagination-container" style="display: none;">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentPage = 1;
        let totalPages = 1;
        const alertsPerPage = 20;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAlertStatistics();
            loadAlerts();
            setupEventListeners();
            setDefaultDates();
        });

        function setupEventListeners() {
            document.getElementById('filter-form').addEventListener('submit', function(e) {
                e.preventDefault();
                currentPage = 1;
                loadAlerts();
            });

            document.getElementById('clear-filters').addEventListener('click', function() {
                clearFilters();
                currentPage = 1;
                loadAlerts();
            });
        }

        function setDefaultDates() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = weekAgo.toISOString().split('T')[0];
        }

        function clearFilters() {
            document.getElementById('filter-form').reset();
            setDefaultDates();
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('alerts-container').style.display = 'none';
            document.getElementById('no-alerts').style.display = 'none';
            document.getElementById('pagination-container').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        async function loadAlertStatistics() {
            try {
                const response = await fetch('/api/alerts/statistics');
                const stats = await response.json();
                
                document.getElementById('total-alerts').textContent = stats.total_alerts;
                document.getElementById('super-alerts').textContent = stats.super_alerts;
                document.getElementById('buy-alerts').textContent = stats.buy_alerts;
                document.getElementById('sell-alerts').textContent = stats.sell_alerts;
                document.getElementById('accuracy-rate').textContent = stats.accuracy_rate + '%';
            } catch (error) {
                console.error('Error loading alert statistics:', error);
            }
        }

        async function loadAlerts() {
            showLoading();
            
            try {
                const filters = getFilters();
                const queryParams = new URLSearchParams({
                    ...filters,
                    limit: alertsPerPage,
                    offset: (currentPage - 1) * alertsPerPage
                });

                const response = await fetch(`/api/alerts?${queryParams}`);
                const data = await response.json();
                
                hideLoading();
                
                if (data.alerts && data.alerts.length > 0) {
                    displayAlerts(data.alerts);
                    updatePagination(data.total_count);
                } else {
                    showNoAlerts();
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
                hideLoading();
                showNoAlerts();
            }
        }

        function getFilters() {
            const filters = {};
            
            const symbol = document.getElementById('symbol-filter').value.trim();
            if (symbol) filters.symbol = symbol;
            
            const alertType = document.getElementById('alert-type-filter').value;
            if (alertType !== 'ALL') filters.alert_type = alertType;
            
            const pattern = document.getElementById('pattern-filter').value;
            if (pattern) filters.pattern_type = pattern;
            
            if (document.getElementById('super-alerts-only').checked) {
                filters.is_super_alert = true;
            }
            
            const startDate = document.getElementById('start-date').value;
            if (startDate) filters.start_date = startDate;
            
            const endDate = document.getElementById('end-date').value;
            if (endDate) filters.end_date = endDate;
            
            const outcome = document.getElementById('outcome-filter').value;
            if (outcome !== 'all') filters.outcome = outcome;
            
            return filters;
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            container.innerHTML = '';
            container.style.display = 'block';
            
            alerts.forEach(alert => {
                const alertCard = createAlertCard(alert);
                container.appendChild(alertCard);
            });
        }

        function createAlertCard(alert) {
            const card = document.createElement('div');
            card.className = `card alert-card mb-3 ${alert.alert_type.toLowerCase() === 'buy' ? 'alert-buy' : 'alert-sell'} ${alert.is_super_alert ? 'super-alert' : ''}`;
            
            const superBadge = alert.is_super_alert ? 
                `<span class="badge super-badge ms-2"><i class="fas fa-star"></i> SUPER</span>` : '';
            
            const matrixScore = alert.pnf_matrix_score ? 
                `<span class="badge bg-info ms-2">Matrix: ${alert.pnf_matrix_score}</span>` : '';
            
            const fibLevel = alert.fibonacci_level ? 
                `<span class="badge bg-warning text-dark ms-2">Fib: ${alert.fibonacci_level}</span>` : '';
            
            const outcomeColor = alert.outcome === 'profit' ? 'success' : 
                                 alert.outcome === 'loss' ? 'danger' : 'secondary';
            
            const outcomeText = alert.outcome ? 
                `<span class="badge bg-${outcomeColor}">${alert.outcome.toUpperCase()}</span>` : 
                '<span class="badge bg-secondary">PENDING</span>';
            
            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="card-title">
                                <i class="fas fa-${alert.alert_type.toLowerCase() === 'buy' ? 'arrow-up text-success' : 'arrow-down text-danger'}"></i>
                                ${alert.symbol}
                                <span class="price-highlight ${alert.alert_type.toLowerCase() === 'buy' ? 'buy-price' : 'sell-price'}">
                                    ₹${alert.signal_price.toFixed(2)}
                                </span>
                                ${superBadge}
                            </h5>
                            <h6 class="card-subtitle mb-2">
                                <span class="badge pattern-badge bg-primary">${alert.pattern_name}</span>
                                ${matrixScore}
                                ${fibLevel}
                                ${outcomeText}
                            </h6>
                            <p class="trigger-reason">${alert.trigger_reason}</p>
                        </div>
                        <div class="text-end">
                            <div class="alert-timestamp">
                                <i class="fas fa-clock"></i>
                                ${new Date(alert.timestamp).toLocaleString()}
                            </div>
                            ${alert.column_number ? `<small class="text-muted">Column: ${alert.column_number}</small>` : ''}
                        </div>
                    </div>

                    ${alert.profit_loss_percent ? `
                        <div class="mt-2">
                            <small class="text-${alert.profit_loss_percent > 0 ? 'success' : 'danger'}">
                                P&L: ${alert.profit_loss_percent > 0 ? '+' : ''}${alert.profit_loss_percent.toFixed(2)}%
                                ${alert.days_to_outcome ? `(${alert.days_to_outcome} days)` : ''}
                            </small>
                        </div>
                    ` : ''}

                    ${alert.notes ? `
                        <div class="mt-2">
                            <small class="text-muted"><i class="fas fa-sticky-note"></i> ${alert.notes}</small>
                        </div>
                    ` : ''}
                </div>
            `;

            // Make card clickable - navigate to test-charts page with alert details
            card.style.cursor = 'pointer';
            card.title = 'Click to view this pattern in test charts';
            card.onclick = function() {
                const params = new URLSearchParams({
                    symbol: alert.symbol,
                    instrument_key: alert.instrument_key || '',
                    pattern: alert.pattern_type,
                    timestamp: alert.timestamp,
                    box_size: '0.0025',  // 0.25% per preference from alerts
                    interval: '1minute',
                    time_range: '2months'
                });
                window.location.href = `/test-charts?${params.toString()}`;
            };

            return card;
        }

        function showNoAlerts() {
            document.getElementById('alerts-container').style.display = 'none';
            document.getElementById('no-alerts').style.display = 'block';
            document.getElementById('pagination-container').style.display = 'none';
        }

        function updatePagination(totalCount) {
            totalPages = Math.ceil(totalCount / alertsPerPage);
            
            if (totalPages <= 1) {
                document.getElementById('pagination-container').style.display = 'none';
                return;
            }
            
            document.getElementById('pagination-container').style.display = 'block';
            
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
            pagination.appendChild(prevLi);
            
            // Page numbers
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
            pagination.appendChild(nextLi);
        }

        function changePage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                currentPage = page;
                loadAlerts();
            }
        }

        // Quick action functions
        function showSuperAlertsOnly() {
            clearFilters();
            document.getElementById('super-alerts-only').checked = true;
            currentPage = 1;
            loadAlerts();
        }

        function showTodayAlerts() {
            clearFilters();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
            document.getElementById('end-date').value = today;
            currentPage = 1;
            loadAlerts();
        }

        function showRecentAlerts() {
            clearFilters();
            setDefaultDates();
            currentPage = 1;
            loadAlerts();
        }

        function refreshAlerts() {
            loadAlertStatistics();
            loadAlerts();
        }

        function exportAlerts() {
            const filters = getFilters();
            const queryParams = new URLSearchParams(filters);
            window.open(`/api/alerts/export?${queryParams}`, '_blank');
        }

        // Telegram test button handler
        document.getElementById('test-telegram-btn').addEventListener('click', async function() {
            const btn = this;
            const resultDiv = document.getElementById('telegram-test-result');

            // Disable button and show loading
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            resultDiv.style.display = 'none';

            try {
                const response = await fetch('/api/test-telegram-alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                // Show result
                resultDiv.style.display = 'block';
                if (data.success) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.message;
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + data.message;
                }

            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error: ' + error.message;
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = '<i class="fab fa-telegram"></i> Test Telegram Alert';
            }
        });

        function showAnalytics() {
            window.open('/alerts/analytics', '_blank');
        }
    </script>
</body>
</html>
